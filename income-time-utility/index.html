<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ—¶é—´-æ”¶å…¥æ•ˆç”¨æ‹Ÿåˆå™¨</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            background: #fafafa;
            color: #333;
        }

        h1 {
            text-align: center;
        }

        .point {
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input {
            width: 120px;
            padding: 6px;
        }

        button {
            padding: 8px 16px;
            margin-top: 10px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.9;
        }

        .result,
        .explanation {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }

        .explanation {
            background: #f0f8ff;
        }

        label {
            display: inline-block;
            width: 100px;
        }
    </style>
</head>

<body>
    <h1>ğŸ’°â±ï¸ æ”¶å…¥-æ—¶é—´æ•ˆç”¨æ‹Ÿåˆå™¨ </h1>
    <p>è¾“å…¥3ä¸ªä½ è®¤ä¸ºâ€œæ•ˆç”¨ç›¸åŒâ€çš„ï¼ˆå¯è‡ªç”±æ”¯é…æ”¶å…¥, å¯è‡ªç”±æ”¯é…æ—¶é—´ï¼‰ç‚¹ï¼Œæ‹Ÿåˆä½ çš„ä¸ªäººåå¥½ã€‚</p>

    <div id="points"></div>

    <button onclick="fit()">æ‹Ÿåˆæˆ‘çš„åå¥½</button>

    <div id="result" class="result" style="display:none;"></div>
    <div id="explanation" class="explanation" style="display:none;"></div>

    <h3>ç­‰æ•ˆè¡¥å¿è®¡ç®—å™¨</h3>
    <p>åŸºäºä½ çš„åå¥½ï¼Œè®¡ç®—ç»´æŒç›¸åŒæ•ˆç”¨æ‰€éœ€çš„è¡¥å¿ï¼š</p>
    <div>
        <label>æ–°æ”¶å…¥ï¼ˆä¸‡å…ƒ/å¹´ï¼‰ï¼š</label>
        <input type="number" id="newIncome" value="50" placeholder="æ–°æ”¶å…¥ï¼ˆè®¡ç®—æ‰€éœ€æ—¶é—´ï¼‰">
        <button onclick="calcByIncome()">è®¡ç®—æ‰€éœ€æ—¶é—´</button>
    </div>
    <div style="margin-top:10px;">
        <label>æ–°æ—¶é—´ï¼ˆå°æ—¶/å‘¨ï¼‰ï¼š</label>
        <input type="number" id="newTime" value="24" placeholder="æ–°æ—¶é—´ï¼ˆè®¡ç®—æ‰€éœ€æ”¶å…¥ï¼‰">
        <button onclick="calcByTime()">è®¡ç®—æ‰€éœ€æ”¶å…¥</button>
    </div>
    <div id="compensation" class="result" style="display:none; margin-top:15px;"></div>

    <script>
        // é»˜è®¤3ä¸ªç‚¹ï¼ˆå¯è‡ªç”±æ”¯é…æ”¶å…¥ï¼Œå¯è‡ªç”±æ”¯é…æ—¶é—´ï¼‰
        const defaultPoints = [
            [25, 48],
            [20, 53],
            [35, 43],
        ];

        function init() {
            const container = document.getElementById('points');
            container.innerHTML = '';
            defaultPoints.forEach((pt, i) => {
                const div = document.createElement('div');
                div.className = 'point';
                div.innerHTML = `
          <strong>ç‚¹ ${i + 1}ï¼š</strong>
          <input type="number" class="income" value="${pt[0]}" step="1"> ä¸‡å…ƒ/å¹´ï¼Œ
          <input type="number" class="time" value="${pt[1]}" step="1"> å°æ—¶/å‘¨
        `;
                container.appendChild(div);
            });
        }

        function getPoints() {
            const inputs = document.querySelectorAll('.point');
            const pts = [];
            for (const div of inputs) {
                const inc = parseFloat(div.querySelector('.income').value);
                const tim = parseFloat(div.querySelector('.time').value);
                if (isNaN(inc) || isNaN(tim)) continue;
                pts.push([inc, tim]);
            }
            return pts;
        }

        function cesUtility(I, T, a, rho) {
            if (Math.abs(rho) < 1e-6) {
                return Math.pow(I, a) * Math.pow(T, 1 - a);
            }
            const val = a * Math.pow(I, rho) + (1 - a) * Math.pow(T, rho);
            return val > 0 ? Math.pow(val, 1 / rho) : NaN;
        }

        function checkI(I) {
            if (isNaN(I) || I < 0) {
                return "å¯è‡ªç”±æ”¯é…æ”¶å…¥åº”ä¸ºéè´Ÿå€¼";
            }
            return null;
        }

        function checkT(T) {
            if (isNaN(T) || T < 0 || T > 168) {
                return "å¯è‡ªç”±æ”¯é…æ—¶é—´åº”åœ¨0åˆ°168å°æ—¶/å‘¨ä¹‹é—´";
            }
            return null;
        }

        // æ£€æŸ¥ç‚¹é›†çš„ä¸€è‡´æ€§
        function checkConsistency(points) {
            if (points.length < 3) return null;

            // æ£€æŸ¥æ˜¯å¦è¿èƒŒå•è°ƒæ€§
            // æœ€å¥½æŒ‡å‡ºå“ªä¸¤ä¸ªç‚¹è¿èƒŒå•è°ƒæ€§
            for (let i = 0; i < points.length; i++) {
                const [I1, T1] = points[i];
                for (let j = 0; j < points.length; j++) {
                    if (i === j) continue;
                    const [I2, T2] = points[j];
                    if (I1 >= I2 && T1 >= T2) {
                        return `ä¸ä¸€è‡´ï¼šç‚¹ ${i + 1}ï¼ˆ${I1} ä¸‡å…ƒ/å¹´, ${T1} å°æ—¶/å‘¨ï¼‰ä¼˜äºç‚¹ ${j + 1}ï¼ˆ${I2} ä¸‡å…ƒ/å¹´, ${T2} å°æ—¶/å‘¨ï¼‰ï¼Œä½†ä½ è®¤ä¸ºå®ƒä»¬æ•ˆç”¨ç›¸åŒã€‚`;
                    }
                }
            }

            for (const [I, T] of points) {
                const errI = checkI(I);
                if (errI) return errI;
                const errT = checkT(T);
                if (errT) return errT;
            }

            return null;
        }

        function fitCES(points) {
            const [I0, T0] = points[0];
            let bestErr = Infinity;
            let bestA = 0.5, bestRho = 0;
            // ç½‘æ ¼æœç´¢
            for (let a = 0.0; a <= 1.0; a += 0.002) {
                for (let rho = -4.0; rho <= 0.9; rho += 0.01) {
                    try {
                        const U0 = cesUtility(I0, T0, a, rho);
                        let err = 0;
                        for (let i = 1; i < points.length; i++) {
                            const [I, T] = points[i];
                            const Ui = cesUtility(I, T, a, rho);
                            err += Math.pow(Math.log(Ui) - Math.log(U0), 2);
                        }
                        if (err < bestErr) {
                            bestErr = err;
                            bestA = a;
                            bestRho = rho;
                        }
                    } catch (e) { /* skip */ }
                }
            }

            return { a: bestA, rho: bestRho };
        }

        function solveForT(I_new, I0, T0, a, rho) {
            const U0 = cesUtility(I0, T0, a, rho);
            if (Math.abs(rho) < 1e-6) {
                return Math.pow(U0 / Math.pow(I_new, a), 1 / (1 - a));
            }
            const target = Math.pow(U0, rho);
            const termI = a * Math.pow(I_new, rho);
            if (termI >= target) return NaN;
            const T_rho = (target - termI) / (1 - a);
            return T_rho > 0 ? Math.pow(T_rho, 1 / rho) : NaN;
        }

        function solveForI(T_new, I0, T0, a, rho) {
            const U0 = cesUtility(I0, T0, a, rho);
            if (Math.abs(rho) < 1e-6) {
                return Math.pow(U0 / Math.pow(T_new, 1 - a), 1 / a);
            }
            const target = Math.pow(U0, rho);
            const termT = (1 - a) * Math.pow(T_new, rho);
            if (termT >= target) return NaN;
            const I_rho = (target - termT) / a;
            return I_rho > 0 ? Math.pow(I_rho, 1 / rho) : NaN;
        }

        let fittedParams = null;

        function fit() {
            const pts = getPoints();
            if (pts.length < 3) {
                alert("è¯·è‡³å°‘è¾“å…¥3ä¸ªæœ‰æ•ˆç‚¹ï¼");
                return;
            }

            const inconsistency_str = checkConsistency(pts);
            if (inconsistency_str) {
                alert("æ•°æ®é—®é¢˜ï¼š\n" + inconsistency_str + "\n\nè¯·è°ƒæ•´ä½ çš„è¾“å…¥ç‚¹ã€‚");
                return;
            }

            fittedParams = fitCES(pts);
            const { a, rho } = fittedParams;
            const sigma = 1 / (1 - rho);

            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = `
        <strong>æ‹Ÿåˆç»“æœï¼š</strong><br>
        â€¢ æ”¶å…¥æƒé‡ a = ${(a * 100).toFixed(1)}%ï¼Œæ—¶é—´æƒé‡ 1 - a = ${((1 - a) * 100).toFixed(1)}%<br>
        â€¢ æ›²ç‡ Ï = ${rho.toFixed(2)}<br>
        â€¢ æ›¿ä»£å¼¹æ€§ Ïƒ = ${sigma.toFixed(2)}<br>
      `;

            let interp = "";
            if (rho > -0.2 && rho < 0.2) {
                interp = "ä½ çš„åå¥½æ¥è¿‘ Cobb-Douglasï¼šä½ å€¾å‘äºæŒ‰å›ºå®šæ¯”ä¾‹äº¤æ¢æ—¶é—´å’Œæ”¶å…¥ï¼ˆä¾‹å¦‚æ”¶å…¥ç¿»å€ï¼Œæ„¿æ„æ¥å—æ—¶é—´å‡åŠï¼‰ã€‚";
            } else if (rho < 0) {
                interp = "Ï < 0, Ïƒ < 1 è¡¨ç¤ºæ—¶é—´å’Œæ”¶å…¥æ˜¯<strong>äº’è¡¥å“</strong>ï¼šå½“ä½ æ—¶é—´å¾ˆå°‘æ—¶ï¼Œä½ æåº¦ä¸æ„¿æ„å†ç‰ºç‰²æ—¶é—´ï¼›æ”¶å…¥å¾ˆä½æ—¶ï¼Œä½ ä¹Ÿæåº¦ä¸æ„¿æ„å†é™è–ªã€‚";
            } else {
                interp = "Ï > 0, Ïƒ > 1 è¡¨ç¤ºæ—¶é—´å’Œæ”¶å…¥æ˜¯<strong>æ›¿ä»£å“</strong>ï¼šä½ å¾ˆå®¹æ˜“ç”¨æ”¶å…¥æ¢æ—¶é—´ï¼ˆæˆ–åä¹‹ï¼‰ï¼Œæ¯”å¦‚æ„¿æ„ä¸ºé«˜è–ªå¤§å¹…åŠ ç­ã€‚";
            }

            document.getElementById('explanation').style.display = 'block';
            document.getElementById('explanation').innerHTML = `<strong>ç›´è§‚è§£é‡Šï¼š</strong><br>${interp}`;
        }

        function calcByIncome() {
            if (!fittedParams) { alert("è¯·å…ˆæ‹Ÿåˆåå¥½ï¼"); return; }
            const I_new = parseFloat(document.getElementById('newIncome').value);
            const errI = checkI(I_new);
            if (errI) {
                alert("è¾“å…¥é”™è¯¯ï¼š\n" + errI);
                return;
            }

            const [I0, T0] = getPoints()[0];
            const T_new = solveForT(I_new, I0, T0, fittedParams.a, fittedParams.rho);
            if (checkT(T_new)) {
                document.getElementById('compensation').textContent = "æ— æ³•è¡¥å¿ï¼ˆæ”¶å…¥è¿‡ä½ï¼‰";
            } else {
                document.getElementById('compensation').textContent =
                    `è‹¥å¹´æ”¶å…¥ä¸º ${I_new} ä¸‡å…ƒï¼Œåˆ™éœ€è¦çº¦ ${T_new.toFixed(1)} å°æ—¶/å‘¨çš„è‡ªç”±æ—¶é—´æ‰èƒ½ä¿æŒç›¸åŒæ•ˆç”¨ã€‚`;
            }
            document.getElementById('compensation').style.display = 'block';
        }

        function calcByTime() {
            if (!fittedParams) { alert("è¯·å…ˆæ‹Ÿåˆåå¥½ï¼"); return; }
            const T_new = parseFloat(document.getElementById('newTime').value);
            if (checkT(T_new)) {
                alert("è¾“å…¥é”™è¯¯ï¼š\n" + checkT(T_new));
                return;
            }
            const [I0, T0] = getPoints()[0];
            const I_new = solveForI(T_new, I0, T0, fittedParams.a, fittedParams.rho);
            if (checkI(I_new)) {
                document.getElementById('compensation').textContent = "æ— æ³•è¡¥å¿ï¼ˆæ—¶é—´è¿‡ä½ï¼‰";
            } else {
                document.getElementById('compensation').textContent =
                    `è‹¥æ¯å‘¨è‡ªç”±æ—¶é—´ä¸º ${T_new} å°æ—¶ï¼Œåˆ™éœ€è¦çº¦ ${I_new.toFixed(1)} ä¸‡å…ƒ/å¹´çš„æ”¶å…¥æ‰èƒ½ä¿æŒç›¸åŒæ•ˆç”¨ã€‚`;
            }
            document.getElementById('compensation').style.display = 'block';
        }

        // åˆå§‹åŒ–
        init();
    </script>
    <hr style="margin-top: 30px;">
    <p style="text-align: center; color: #666; font-size: 0.9em;">
        <a href="https://github.com/Ethkuil/lab" target="_blank" rel="noopener">View source on GitHub</a>
    </p>
</body>

</html>